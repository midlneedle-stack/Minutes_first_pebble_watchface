#include <pebble.h>

#define SMALL_WIDTH 10
#define SMALL_HEIGHT 14
#define SMALL_SPACING 22
#define SMALL_MARGIN 12
#define SMALL_DIGIT_GAP 2

#define LARGE_WIDTH 20
#define LARGE_HEIGHT 28
#define LARGE_DIGIT_GAP 4

static Window *s_main_window;
static Layer *s_canvas_layer;
static int s_hour = 12;
static int s_minute = 0;

static const char *SMALL_DIGITS[10][SMALL_HEIGHT] = {
  {
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "0011111100",
    "0011111100"
  },
  {
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000",
    "0000110000"
  },
  {
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "0000000011",
    "0000000011",
    "0000001100",
    "0000001100",
    "0000110000",
    "0000110000",
    "0011000000",
    "0011000000",
    "1111111111",
    "1111111111"
  },
  {
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "0000000011",
    "0000000011",
    "0000111100",
    "0000111100",
    "0000000011",
    "0000000011",
    "1100000011",
    "1100000011",
    "0011111100",
    "0011111100"
  },
  {
    "0000001111",
    "0000001111",
    "0000110011",
    "0000110011",
    "0011000011",
    "0011000011",
    "1100000011",
    "1100000011",
    "1111111111",
    "1111111111",
    "0000000011",
    "0000000011",
    "0000000011",
    "0000000011"
  },
  {
    "1111111111",
    "1111111111",
    "1100000000",
    "1100000000",
    "1100000000",
    "1100000000",
    "1111111100",
    "1111111100",
    "0000000011",
    "0000000011",
    "0000000011",
    "0000000011",
    "1111111100",
    "1111111100"
  },
  {
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "1100000000",
    "1100000000",
    "1111111100",
    "1111111100",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "0011111100",
    "0011111100"
  },
  {
    "1111111111",
    "1111111111",
    "0000000011",
    "0000000011",
    "0000001100",
    "0000001100",
    "0000110000",
    "0000110000",
    "0011000000",
    "0011000000",
    "1100000000",
    "1100000000",
    "1100000000",
    "1100000000"
  },
  {
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "0011111100",
    "0011111100"
  },
  {
    "0011111100",
    "0011111100",
    "1100000011",
    "1100000011",
    "1100000011",
    "1100000011",
    "0011111111",
    "0011111111",
    "0000000011",
    "0000000011",
    "0000001100",
    "0000001100",
    "0011110000",
    "0011110000"
  }
};

static const char *LARGE_DIGITS[10][LARGE_HEIGHT] = {
  {
    "00001111111111110000",
    "00001111111111110000",
    "00111111111111111100",
    "00111111111111111100",
    "11111100000000111111",
    "11111100000000111111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11111100000000111111",
    "11111100000000111111",
    "00111111111111111100",
    "00111111111111111100",
    "00001111111111110000",
    "00001111111111110000"
  },
  {
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000",
    "00000000111100000000"
  },
  {
    "00001111111111110000",
    "00001111111111110000",
    "00111111111111111100",
    "00111111111111111100",
    "11111100000000111111",
    "11111100000000111111",
    "11110000000000001111",
    "11110000000000001111",
    "00000000000000001111",
    "00000000000000001111",
    "00000000000000111111",
    "00000000000000111111",
    "00000000001111111100",
    "00000000001111111100",
    "00000011111111000000",
    "00000011111111000000",
    "00001111111100000000",
    "00001111111100000000",
    "00111111000000000000",
    "00111111000000000000",
    "00111100000000000000",
    "00111100000000000000",
    "11111100000000000000",
    "11111100000000000000",
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111"
  },
  {
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111",
    "00000000000011111100",
    "00000000000011111100",
    "00000000001111110000",
    "00000000001111110000",
    "00000000111111000000",
    "00000000111111000000",
    "00000011111111110000",
    "00000011111111110000",
    "00000011111111111100",
    "00000011111111111100",
    "00000000000000111111",
    "00000000000000111111",
    "00000000000000001111",
    "00000000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11111100000000111111",
    "11111100000000111111",
    "00111111111111111100",
    "00111111111111111100",
    "00001111111111110000",
    "00001111111111110000"
  },
  {
    "00000000000011111100",
    "00000000000011111100",
    "00000000001111111100",
    "00000000001111111100",
    "00000000111111111100",
    "00000000111100111100",
    "00000011111100111100",
    "00001111110000111100",
    "00111111110000111100",
    "00111111000000111100",
    "11111111000000111100",
    "11111100000000111100",
    "11111100000000111100",
    "11110000000000111100",
    "11110000000000111100",
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100",
    "00000000000000111100"
  },
  {
    "01111111111111111111",
    "01111111111111111111",
    "01111111111111111111",
    "11111111111111111111",
    "11110000000000000000",
    "11110000000000000000",
    "11110000000000000000",
    "11110000000000000000",
    "11110011111111110000",
    "11110011111111110000",
    "11111111111111111100",
    "11111100000011111100",
    "11111100000011111111",
    "11111000000000111111",
    "11111000000000111111",
    "00000000000000001111",
    "00000000000000001111",
    "00000000000000001111",
    "00000000000000001111",
    "00000000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11111100000000111111",
    "11111100000000111111",
    "00111111111111111100",
    "00111111111111111100",
    "00001111111111110000",
    "00001111111111110000"
  },
  {
    "00001111111111110000",
    "00001111111111110000",
    "00111111111111111100",
    "00111111111111111100",
    "11111100000000111111",
    "11111100000000111111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000000000",
    "11110000000000000000",
    "11110011111111110000",
    "11110011111111110000",
    "11111111111111111100",
    "11111111111111111100",
    "11111100000000111111",
    "11111100000000111111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11111100000000111111",
    "11111100000000111111",
    "00111111111111111100",
    "00111111111111111100",
    "00001111111111110000",
    "00001111111111110000"
  },
  {
    "11111111111111111111",
    "11111111111111111111",
    "11111111111111111111",
    "00000000000000001111",
    "00000000000000001111",
    "00000000000000111111",
    "00000000000000111111",
    "00000000000000111111",
    "00000000000000111100",
    "00000000000011111100",
    "00000000000011111100",
    "00000000000011111100",
    "00000000000011110000",
    "00000000001111110000",
    "00000000001111110000",
    "00000000001111110000",
    "00000000001111000000",
    "00000000111111000000",
    "00000000111111000000",
    "00000000111111000000",
    "00000000111100000000",
    "00000011111100000000",
    "00000011111100000000",
    "00000011111100000000",
    "00000011110000000000",
    "00000011110000000000",
    "00001111110000000000",
    "00001111110000000000"
  },
  {
    "00001111111111110000",
    "00001111111111110000",
    "00111111111111111100",
    "00111111111111111100",
    "11111100000000111111",
    "11111100000000111111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "00111111111111111100",
    "00111111111111111100",
    "00111111111111111100",
    "00111111111111111100",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11110000000000001111",
    "11111100000000111111",
    "11111100000000111111",
    "00111111111111111100",
    "00111111111111111100",
    "00001111111111110000",
    "00001111111111110000"
  },
  {
    "01111111111111111110",
    "01111111111111111110",
    "01111111111111111110",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "11100000000000000111",
    "01111111111111111110",
    "01111111111111111110",
    "01111111111111111110",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "00000000000000000111",
    "01111111111111111110",
    "01111111111111111110",
    "01111111111111111110"
  }
};

static void draw_digit_bitmap(GContext *ctx, const char *rows[], int width, int height, GPoint origin, GColor color) {
  graphics_context_set_fill_color(ctx, color);
  for(int y = 0; y < height; ++y) {
    const char *row = rows[y];
    for(int x = 0; x < width; ++x) {
      if(row[x] == '1') {
        graphics_fill_rect(ctx, GRect(origin.x + x, origin.y + y, 1, 1), 0, GCornerNone);
      }
    }
  }
}

static void draw_small_number(GContext *ctx, int value, GPoint center, GColor color) {
  char buffer[3];
  snprintf(buffer, sizeof(buffer), "%d", value);
  int len = strlen(buffer);
  int total_width = len * SMALL_WIDTH + (len - 1) * SMALL_DIGIT_GAP;
  int start_x = center.x - total_width / 2;
  int start_y = center.y - SMALL_HEIGHT / 2;

  for(int i = 0; i < len; ++i) {
    int digit = buffer[i] - '0';
    GPoint origin = GPoint(start_x + i * (SMALL_WIDTH + SMALL_DIGIT_GAP), start_y);
    draw_digit_bitmap(ctx, SMALL_DIGITS[digit], SMALL_WIDTH, SMALL_HEIGHT, origin, color);
  }
}

static void draw_minutes(GContext *ctx, GRect bounds) {
  char buffer[3];
  snprintf(buffer, sizeof(buffer), "%02d", s_minute);

  int total_width = 2 * LARGE_WIDTH + LARGE_DIGIT_GAP;
  int start_x = (bounds.size.w - total_width) / 2;
  int start_y = (bounds.size.h - LARGE_HEIGHT) / 2;

  for(int i = 0; i < 2; ++i) {
    int digit = buffer[i] - '0';
    GPoint origin = GPoint(start_x + i * (LARGE_WIDTH + LARGE_DIGIT_GAP), start_y);
    draw_digit_bitmap(ctx, LARGE_DIGITS[digit], LARGE_WIDTH, LARGE_HEIGHT, origin, GColorWhite);
  }
}

static void draw_hours_ring(GContext *ctx, GRect bounds) {
  const int cx = bounds.size.w / 2;
  const int cy = bounds.size.h / 2;

  const int top_y = SMALL_MARGIN + SMALL_HEIGHT / 2;
  const int bottom_y = bounds.size.h - SMALL_MARGIN - SMALL_HEIGHT / 2;
  const int left_x = SMALL_MARGIN + SMALL_WIDTH / 2;
  const int right_x = bounds.size.w - SMALL_MARGIN - SMALL_WIDTH / 2;

  const int horizontal_offset = SMALL_WIDTH + SMALL_SPACING;
  const int vertical_offset = SMALL_HEIGHT + SMALL_SPACING;

  GPoint centers[] = {
    {cx - horizontal_offset, top_y}, // 11
    {cx, top_y},                     // 12
    {cx + horizontal_offset, top_y}, // 1
    {right_x, cy - vertical_offset}, // 2
    {right_x, cy},                   // 3
    {right_x, cy + vertical_offset}, // 4
    {cx + horizontal_offset, bottom_y}, // 5
    {cx, bottom_y},                     // 6
    {cx - horizontal_offset, bottom_y}, // 7
    {left_x, cy + vertical_offset},     // 8
    {left_x, cy},                       // 9
    {left_x, cy - vertical_offset}      // 10
  };

  const int numbers[] = {11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10};

  const GColor active = GColorWhite;
  const GColor inactive = PBL_IF_COLOR_ELSE(GColorFromRGB(0x55, 0x55, 0x55), GColorLightGray);

  for(size_t i = 0; i < ARRAY_LENGTH(numbers); ++i) {
    GColor color = (numbers[i] == s_hour) ? active : inactive;
    draw_small_number(ctx, numbers[i], centers[i], color);
  }
}

static void canvas_update_proc(Layer *layer, GContext *ctx) {
  GRect bounds = layer_get_bounds(layer);

  graphics_context_set_fill_color(ctx, GColorBlack);
  graphics_fill_rect(ctx, bounds, 0, GCornerNone);

  draw_hours_ring(ctx, bounds);
  draw_minutes(ctx, bounds);
}

static void update_time(void) {
  time_t now = time(NULL);
  struct tm *tick_time = localtime(&now);

  int hour = tick_time->tm_hour % 12;
  if(hour == 0) {
    hour = 12;
  }

  s_hour = hour;
  s_minute = tick_time->tm_min;

  if(s_canvas_layer) {
    layer_mark_dirty(s_canvas_layer);
  }
}

static void tick_handler(struct tm *tick_time, TimeUnits units_changed) {
  if(units_changed & MINUTE_UNIT) {
    update_time();
  }
}

static void main_window_load(Window *window) {
  window_set_background_color(window, GColorBlack);

  Layer *window_layer = window_get_root_layer(window);
  GRect bounds = layer_get_bounds(window_layer);

  s_canvas_layer = layer_create(bounds);
  layer_set_update_proc(s_canvas_layer, canvas_update_proc);
  layer_add_child(window_layer, s_canvas_layer);
}

static void main_window_unload(Window *window) {
  layer_destroy(s_canvas_layer);
}

static void init(void) {
  s_main_window = window_create();

  window_set_window_handlers(s_main_window, (WindowHandlers) {
    .load = main_window_load,
    .unload = main_window_unload
  });

  window_stack_push(s_main_window, true);

  tick_timer_service_subscribe(MINUTE_UNIT, tick_handler);
  update_time();
}

static void deinit(void) {
  tick_timer_service_unsubscribe();
  window_destroy(s_main_window);
}

int main(void) {
  init();
  app_event_loop();
  deinit();
}
